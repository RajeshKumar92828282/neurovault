name: Build and Release Stylus WASM

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      publish_to_pages:
        description: 'Also publish the built wasm to GitHub Pages (boolean)'
        required: false
        default: 'false'
      release_tag:
        description: 'Optional release tag to create (e.g. v1.2.3 or stylus-wasm-v1)'
        required: false
        default: ''

jobs:
  build-wasm:
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.create_release.outputs.tag_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown

      - name: Add wasm target
        run: rustup target add wasm32-unknown-unknown

      - name: Build Stylus crate to WASM
        working-directory: ./contracts/stylus/memory_registry
        run: |
          set -e
          # Prefer cargo build for simple crates. If you rely on wasm-pack,
          # replace this with `wasm-pack build --release`.
          cargo build --target wasm32-unknown-unknown --release

      - name: Collect wasm artifact
        run: |
          set -e
          # Try to find the produced wasm in the crate target directory
          wasm_path=$(find ./contracts/stylus -type f -path '*/target/wasm32-unknown-unknown/release/*.wasm' -print -quit)
          if [ -z "$wasm_path" ]; then
            echo "WASM artifact not found in target directory" >&2
            exit 1
          fi
          echo "Found wasm: $wasm_path"
          cp "$wasm_path" ./stylus_wasm.wasm
          sha256sum stylus_wasm.wasm | awk '{print $1}' > stylus_wasm.wasm.sha256

      - name: Upload artifact (workflow)
        uses: actions/upload-artifact@v4
        with:
          name: stylus-wasm-artifacts
          path: |
            stylus_wasm.wasm
            stylus_wasm.wasm.sha256

      - name: Determine release tag
        id: determine_tag
        run: |
          if [ -n "${{ github.event.inputs.release_tag }}" ]; then
            echo "tag=${{ github.event.inputs.release_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=stylus-wasm-${GITHUB_SHA}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ steps.determine_tag.outputs.tag }}
          release_name: "Stylus WASM build ${{ github.run_number }}"
          body: |
            Automated Stylus WASM build produced by CI run `${{ github.run_id }}`.
            Artifact: `stylus_wasm.wasm`
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload wasm to Release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./stylus_wasm.wasm
          asset_name: stylus_wasm.wasm
          asset_content_type: application/wasm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload sha256 to Release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./stylus_wasm.wasm.sha256
          asset_name: stylus_wasm.wasm.sha256
          asset_content_type: text/plain
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare GitHub Pages directory
        if: ${{ (github.event_name == 'workflow_dispatch' && (github.event.inputs.publish_to_pages == 'true')) || (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
        run: |
          echo "<!-- Generated by CI -->" > ./gh-pages-temp/index.html
          mkdir -p ./gh-pages-temp/wasm
          cp ./stylus_wasm.wasm ./gh-pages-temp/wasm/stylus_wasm.wasm

      - name: Publish to GitHub Pages
        if: ${{ (github.event_name == 'workflow_dispatch' && (github.event.inputs.publish_to_pages == 'true')) || (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-temp

  smoke-test:
    needs: build-wasm
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: stylus-wasm-artifacts
          path: ./artifacts

      - name: Verify WASM can be instantiated
        run: |
          node ./scripts/verify_wasm_fetch.js --local ./artifacts/stylus_wasm.wasm

# TODO: Consider publishing the wasm artifact to a stable URL (GitHub Pages,
# an S3 bucket, Cloudflare R2, or a CDN) so the frontend can fetch it directly.